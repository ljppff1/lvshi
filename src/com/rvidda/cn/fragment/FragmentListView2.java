package com.rvidda.cn.fragment;import java.util.ArrayList;import java.util.HashMap;import java.util.Hashtable;import java.util.List;import java.util.Map;import org.json.JSONException;import org.json.JSONObject;import android.content.Intent;import android.graphics.Color;import android.os.Bundle;import android.support.annotation.Nullable;import android.support.v4.app.Fragment;import android.text.Spannable;import android.view.Gravity;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.AdapterView;import android.widget.Toast;import android.widget.AdapterView.OnItemClickListener;import com.dian.diabetes.widget.listview.PullRefListView;import com.dian.diabetes.widget.listview.PullRefListView.IXListViewListener;import com.easemob.chat.EMChatManager;import com.easemob.chat.EMConversation;import com.easemob.chat.EMMessage;import com.easemob.chat.TextMessageBody;import com.easemob.exceptions.EaseMobException;import com.fanxin.app.fx.ChatActivity;import com.fanxin.app.utils.SmileUtils;import com.jauker.widget.BadgeView;import com.rvidda.cn.R;import com.rvidda.cn.adapter.LvShiShouYeAdapter2;import com.rvidda.cn.domain.LSSYList;import com.rvidda.cn.ui.LvShiShouYe;import com.rvidda.cn.utils.DateUtil;public class FragmentListView2 extends Fragment {	private View parentView;	private List<String> str = new ArrayList<String>();	private PullRefListView listView1;	private LvShiShouYeAdapter2 adapter1;	private List<EMConversation> normal_list = new ArrayList<EMConversation>();    private List<EMMessage> list_message =new ArrayList<EMMessage>();    private List<EMMessage> list_message_unread =new ArrayList<EMMessage>();    //未读数量    private Map<String, Integer> list_map =new HashMap<String,Integer>();    //第一条信息    private Map<String, EMMessage> list_body =new HashMap<String,EMMessage>();	private List<LSSYList> data1 = new ArrayList<LSSYList>();	private List<LSSYList> pageList = new ArrayList<LSSYList>();	@Override	@Nullable	public View onCreateView(LayoutInflater inflater,			@Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {		parentView = inflater.inflate(R.layout.fragment_listview2, container,				false);		//已答		listView1 = (com.dian.diabetes.widget.listview.PullRefListView) parentView.findViewById(R.id.news_list);		listView1.setOnItemClickListener(new OnItemClickListener() {			@Override			public void onItemClick(AdapterView<?> parent, View view,					int position, long id) {				if (position == 0 || position == -1) {					return;				}				if (position == data1.size() + 1) {					initgetziliao1();				}				if(position>0){										Intent intent = new Intent();					intent.putExtra("SUBJECT",  data1.get(position-1).getSubject());					intent.putExtra("userId", data1.get(position-1).getHx_user());					intent.putExtra("userAvatar",data1.get(position-1).getPhoto());					intent.putExtra("userNick",  data1.get(position-1).getName());					intent.putExtra("PHOTO", data1.get(position-1).getPhoto());					intent.setClass(getActivity(), ChatActivity.class);                   startActivity(intent);									}			}		});		listView1.setXListViewListener(new IXListViewListener() {			private long curentTime;			@Override			public void onRefresh() {				curentTime = System.currentTimeMillis();				initgetziliao1();							}			@Override			public void onLoadMore() {				initgetziliao1();			}		});		adapter1 = new LvShiShouYeAdapter2(getActivity(), data1);		listView1.setPullLoadEnable(false);		listView1.setAdapter(adapter1);		initgetziliao1();		return parentView;	}	private void getHuanXin(){		normal_list.addAll(loadConversationsWithRecentChat());        	for(int j=0;j<normal_list.size();j++){        		list_message.addAll(normal_list.get(j).getAllMessages());        	}//[msg{from:hx_14, to:hx_11 body:txt:"图鸡鸡鸡鸡", msg{from:hx_14, to:hx_11 body:txt:"图V5咯", msg{from:hx_14, to:hx_11 body:txt:"国家科技奖了", msg{from:hx_14, to:hx_11 body:txt:"图鸡鸡鸡鸡", msg{from:hx_14, to:hx_11 body:txt:"图V5咯", msg{from:hx_14, to:hx_11 body:txt:"国家科技奖了", msg{from:hx_14, to:hx_11 body:txt:"图鸡鸡鸡鸡", msg{from:hx_14, to:hx_11 body:txt:"图V5咯", msg{from:hx_14, to:hx_11 body:txt:"国家科技奖了", msg{from:hx_14, to:hx_11 body:txt:"图鸡鸡鸡鸡", msg{from:hx_14, to:hx_11 body:txt:"图V5咯", msg{from:hx_14, to:hx_11 body:txt:"国家科技奖了", msg{from:hx_14, to:hx_11 body:txt:"图鸡鸡鸡鸡", msg{from:hx_14, to:hx_11 body:txt:"图V5咯", msg{from:hx_14, to:hx_11 body:txt:"国家科技奖了", msg{from:hx_14, to:hx_11 body:txt:"图鸡鸡鸡鸡", msg{from:hx_14, to:hx_11 body:txt:"图V5咯", msg{from:hx_14, to:hx_11 body:txt:"国家科技奖了"]        	        //得到所有的第一条的那个信息        for(int i=0;i<list_message.size();i++){				try {					list_body.put(list_message.get(i).getStringAttribute("subject"), list_message.get(i));				} catch (EaseMobException e) {					e.printStackTrace();				}        }               for(int i=0;i<list_message.size();i++){    	   if(list_message.get(i).isUnread()){			list_message_unread.add(list_message.get(i));		}         }   for(int i=0;i<list_message_unread.size();i++){    	   try {             			for(int j=0;j<list_map.size();j++){				if(list_map.containsKey(list_message_unread.get(i).getStringAttribute("SUBJECT"))){				list_map.put(list_message_unread.get(i).getStringAttribute("SUBJECT"), list_map.get(j).getInteger(list_message_unread.get(i).getStringAttribute("SUBJECT"))+1);				}else{					list_map.put(list_message_unread.get(i).getStringAttribute("SUBJECT"), 1);				}			}		} catch (EaseMobException e) {			e.printStackTrace();		}       }       initgetziliao1();	}	/**	 * 获取所有会话	 * 	 * @param context	 * @return +	 */	private List<EMConversation> loadConversationsWithRecentChat() {		// 获取所有会话，包括陌生人		Hashtable<String, EMConversation> conversations = EMChatManager				.getInstance().getAllConversations();		List<EMConversation> list = new ArrayList<EMConversation>();		// 置顶列表再刷新一次		// 过滤掉messages seize为0的conversation		for (EMConversation conversation : conversations.values()) {			if (conversation.getAllMessages().size() != 0) {				// 不在置顶列表里面					list.add(conversation);			}		}		return list;	}	/**	 * 已答列表	 */	private void initgetziliao1()	{			Map<String, Object> params = new HashMap<String, Object>();		com.rvidda.cn.http.HttpServiceUtil.request(com.rvidda.cn.http.ContantsUtil.YiDaliebiao, "get", params,				new com.rvidda.cn.http.HttpServiceUtil.CallBack() {					@Override					public void callback(String json) {						try {							if(!json.equals("0")){							JSONObject jsonObj = new JSONObject(json);                            org.json.JSONArray jsub =jsonObj.getJSONArray("subjects");                         /**                          * {"subjects":[{"id":284,"title":"","created_at":"2016-01-10 21:25:37","subject_lawyer":{"id":327,"lawyer_id":10,"state":"accepted"},                          * "user":{"id":37,"name":null,"avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/Fhab9G1MW-m0MPH0mqVk3QAmUvDa","hx_user":"hx_37"},"labels":[{"id":8,"name":"交通"},{"id":5,"name":"合同"}]},{"id":283,"title":"","created_at":"2016-01-10 20:53:02","subject_lawyer":{"id":319,"lawyer_id":10,"state":"accepted"},"user":{"id":39,"name":null,"avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/Fhab9G1MW-m0MPH0mqVk3QAmUvDa","hx_user":"hx_39"},"labels":[{"id":3,"name":"婚姻"},{"id":5,"name":"合同"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":13,"name":"房屋"},{"id":9,"name":"劳动争议"}]},{"id":282,"title":"","created_at":"2016-01-10 20:48:44","subject_lawyer":{"id":315,"lawyer_id":10,"state":"accepted"},"user":{"id":39,"name":null,"avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/Fhab9G1MW-m0MPH0mqVk3QAmUvDa","hx_user":"hx_39"},"labels":[{"id":9,"name":"劳动争议"}]},{"id":280,"title":"","created_at":"2016-01-10 20:42:26","subject_lawyer":{"id":307,"lawyer_id":10,"state":"accepted"},"user":{"id":10,"name":"姐姐家火锅吃得很开心？在家里面还有很多其","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110204213861495228-25164471","hx_user":"hx_10"},"labels":[{"id":9,"name":"劳动争议"}]},{"id":279,"title":"","created_at":"2016-01-10 19:59:35","subject_lawyer":{"id":302,"lawyer_id":10,"state":"accepted"},"user":{"id":10,"name":"姐姐家火锅吃得很开心？在家里面还有很多其","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110204213861495228-25164471","hx_user":"hx_10"},"labels":[{"id":3,"name":"婚姻"},{"id":5,"name":"合同"}]},{"id":278,"title":"","created_at":"2016-01-10 19:31:21","subject_lawyer":{"id":297,"lawyer_id":10,"state":"accepted"},"user":{"id":10,"name":"姐姐家火锅吃得很开心？在家里面还有很多其","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110204213861495228-25164471","hx_user":"hx_10"},"labels":[{"id":3,"name":"婚姻"},{"id":13,"name":"房屋"},{"id":5,"name":"合同"}]},{"id":276,"title":"","created_at":"2016-01-10 18:14:03","subject_lawyer":{"id":293,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":9,"name":"劳动争议"}]},{"id":275,"title":"","created_at":"2016-01-10 18:13:34","subject_lawyer":{"id":290,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":9,"name":"劳动争议"}]},{"id":272,"title":"","created_at":"2016-01-10 15:50:14","subject_lawyer":{"id":286,"lawyer_id":10,"state":"accepted"},"user":{"id":9,"name":"测试律师","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160102193859931489298-74616547","hx_user":"hx_9"},"labels":[{"id":8,"name":"交通"},{"id":13,"name":"房屋"},{"id":3,"name":"婚姻"}]},{"id":271,"title":"","created_at":"2016-01-10 15:49:33","subject_lawyer":{"id":282,"lawyer_id":10,"state":"accepted"},"user":{"id":9,"name":"测试律师","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160102193859931489298-74616547","hx_user":"hx_9"},"labels":[{"id":8,"name":"交通"},{"id":5,"name":"合同"}]},{"id":270,"title":"","created_at":"2016-01-10 15:48:56","subject_lawyer":{"id":274,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":8,"name":"交通"},{"id":10,"name":"知识产权"}]},{"id":269,"title":"","created_at":"2016-01-10 15:46:37","subject_lawyer":{"id":270,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":8,"name":"交通"},{"id":10,"name":"知识产权"}]},{"id":268,"title":"","created_at":"2016-01-10 15:46:22","subject_lawyer":{"id":265,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"},{"id":8,"name":"交通"}]},{"id":267,"title":"","created_at":"2016-01-10 15:44:14","subject_lawyer":{"id":262,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":10,"name":"知识产权"},{"id":5,"name":"合同"},{"id":10,"name":"知识产权"}]},{"id":266,"title":"","created_at":"2016-01-10 15:43:47","subject_lawyer":{"id":258,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":10,"name":"知识产权"},{"id":5,"name":"合同"}]},{"id":265,"title":"","created_at":"2016-01-10 15:40:52","subject_lawyer":{"id":254,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":10,"name":"知识产权"}]},{"id":264,"title":"","created_at":"2016-01-10 15:38:46","subject_lawyer":{"id":250,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"}]},{"id":263,"title":"","created_at":"2016-01-10 15:36:01","subject_lawyer":{"id":247,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"},{"id":5,"name":"合同"}]},{"id":262,"title":"","created_at":"2016-01-10 15:35:47","subject_lawyer":{"id":242,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"},{"id":5,"name":"合同"}]},{"id":259,"title":"","created_at":"2016-01-10 15:28:49","subject_lawyer":{"id":239,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":5,"name":"合同"},{"id":9,"name":"劳动争议"},{"id":3,"name":"婚姻"},{"id":8,"name":"交通"},{"id":3,"name":"婚姻"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":5,"name":"合同"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":5,"name":"合同"}]},{"id":258,"title":"","created_at":"2016-01-10 15:28:11","subject_lawyer":{"id":235,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":5,"name":"合同"},{"id":3,"name":"婚姻"},{"id":8,"name":"交通"},{"id":3,"name":"婚姻"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":5,"name":"合同"},{"id":9,"name":"劳动争议"}]},{"id":257,"title":"","created_at":"2016-01-10 15:27:30","subject_lawyer":{"id":230,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"},{"id":8,"name":"交通"}]},{"id":256,"title":"","created_at":"2016-01-10 15:27:14","subject_lawyer":{"id":227,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"}]},{"id":255,"title":"","created_at":"2016-01-10 15:26:38","subject_lawyer":{"id":224,"lawyer_id":10,"state":"accepted"},"user":{"id":11,"name":"龙客户","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110161515969127006-92273378","hx_user":"hx_11"},"labels":[{"id":3,"name":"婚姻"}]},{"id":238,"title":"","created_at":"2016-01-10 10:58:25","subject_lawyer":{"id":216,"lawyer_id":10,"state":"accepted"},"user":{"id":10,"name":"姐姐家火锅吃得很开心？在家里面还有很多其","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110204213861495228-25164471","hx_user":"hx_10"},"labels":[{"id":3,"name":"婚姻"},{"id":8,"name":"交通"},{"id":5,"name":"合同"}]},{"id":237,"title":"","created_at":"2016-01-10 10:51:39","subject_lawyer":{"id":211,"lawyer_id":10,"state":"accepted"},"user":{"id":10,"name":"姐姐家火锅吃得很开心？在家里面还有很多其","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110204213861495228-25164471","hx_user":"hx_10"},"labels":[{"id":3,"name":"婚姻"}]},{"id":236,"title":"","created_at":"2016-01-10 10:42:33","subject_lawyer":{"id":206,"lawyer_id":10,"state":"accepted"},"user":{"id":10,"name":"姐姐家火锅吃得很开心？在家里面还有很多其","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/20160110204213861495228-25164471","hx_user":"hx_10"},"labels":[{"id":3,"name":"婚姻"}]},{"id":230,"title":"","created_at":"2016-01-09 22:04:43","subject_lawyer":{"id":197,"lawyer_id":10,"state":"accepted"},"user":{"id":2,"name":"龙律师","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/hahaha","hx_user":"hx_2"},"labels":[{"id":3,"name":"婚姻"}]},{"id":227,"title":"法国哥哥哥哥发了个哥哥 v 股份有限公司","created_at":"2016-01-09 21:57:19","subject_lawyer":{"id":193,"lawyer_id":10,"state":"doing"},"user":{"id":2,"name":"龙律师","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/hahaha","hx_user":"hx_2"},"labels":[{"id":3,"name":"婚姻"},{"id":5,"name":"合同"},{"id":8,"name":"交通"},{"id":10,"name":"知识产权"},{"id":11,"name":"税务"},{"id":13,"name":"房屋"},{"id":9,"name":"劳动争议"}]},{"id":226,"title":"更后悔过","created_at":"2016-01-09 21:53:07","subject_lawyer":{"id":189,"lawyer_id":10,"state":"accepted"},"user":{"id":2,"name":"龙律师","avatar_url":"http://7u2gfi.com1.z0.glb.clouddn.com/hahaha","hx_user":"hx_2"},"labels":[{"id":8,"name":"交通"}]},{"id":225,"title":"哈哈哈就不","created_at":"2016-01-09 21:51:57","subject_lawyer":{"id":185,"lawyer_id":10,"state":"accepted"},"user":{"id":2,"name":"龙律师","avatar_url":"http://7...                          */                                                      pageList.clear();                            for(int i=0;i<jsub.length();i++){                            	LSSYList zx =new LSSYList();                            	zx.setName(((JSONObject)jsub.get(i)).getString("title"));                            	zx.setUserid(((JSONObject)jsub.get(i)).getJSONObject("user").getString("id"));                            	zx.setPhoto(((JSONObject)jsub.get(i)).getJSONObject("user").getString("avatar_url"));                            	zx.setHx_user(((JSONObject)jsub.get(i)).getJSONObject("user").getString("hx_user"));                            	zx.setSubject(((JSONObject)jsub.get(i)).getString("id"));                            	zx.setPhoto(((JSONObject)jsub.get(i)).getJSONObject("user").getString("avatar_url"));                            	String time =((JSONObject)jsub.get(i)).getString("created_at");                            	zx.setTime(time.substring(time.length()-8, time.length()));                                if(list_body.containsKey(((JSONObject)jsub.get(i)).getString("id"))){                                	EMMessage dd = list_body.get(((JSONObject)jsub.get(i)).getString("id"));                                		TextMessageBody txtBody = (TextMessageBody) dd.getBody();                                		Spannable span = SmileUtils                                				.getSmiledText(getActivity(), txtBody.getMessage());                                	zx.setSp(span);                                }else{                            		Spannable span = SmileUtils                            				.getSmiledText(getActivity(),"暂无消息");                                	zx.setSp(span);                                }                            	                            	if(list_map.containsKey(((JSONObject)jsub.get(i)).getString("id"))){                            		zx.setNumber(list_map.get(((JSONObject)jsub.get(i)).getString("id"))+"");                            	}else{                            	zx.setNumber("0");                            	}                            	str.clear();                            	org.json.JSONArray labels = ((JSONObject)jsub.get(i)).getJSONArray("labels");                            	for(int j=0;j<labels.length();j++){                            		str.add(((JSONObject)labels.get(j)).getString("name"));                            	}                            	zx.setBiaoqian(str);                            	pageList.add(zx);                            }								data1.clear();							    data1.addAll(pageList);								listView1.setPullLoadEnable(false);														onLoad1();														}else{			                       Toast.makeText(getActivity(), R.string.log6, 0).show();										}						} catch (JSONException e) {							e.printStackTrace();						}					}				});	}	private void onLoad1() {		listView1.stopRefresh();		listView1.stopLoadMore();		listView1.setRefreshTime(DateUtil.getNowTime());	}}